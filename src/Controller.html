<div class="rr-controller">
  <div class="rr-timeline">
    <span class="rr-timeline__time">{formatTime(currentTime)}</span>
    <div class="rr-progress">
      <div class="rr-progress__step" ref:step style="width: {percentage}"></div>
      <div class="rr-progress__handler" ref:handler style="left: {percentage}"></div>
    </div>
    <span class="rr-timeline__time">{formatTime(meta.totalTime)}</span>
  </div>
  <div class="rr-controller__btns">
    <button on:click="toggle()">
      {isPlaying ? 'pause' : 'play'}
    </button>
    {#each [1, 2, 4, 8] as s}
    <button class:active="s === speed" on:click="set({ speed: s })">{s}x</button>
    {/each}
  </div>
</div>

<script>
  import { formatTime } from './utils.js';

  export default {
    data() {
      return {
        currentTime: 0,
        isPlaying: false,
        speed: 1,
      };
    },
    computed: {
      meta({ replayer }) {
        return replayer.getMetaData();
      },
      percentage({ currentTime, meta }) {
        const percent = Math.min(1, currentTime / meta.totalTime);
        return `${100 * percent}%`;
      },
    },
    helpers: {
      formatTime,
    },
    methods: {
      loopTimer() {
        const now = performance.now();
        let lastStep = now;
        const self = this;

        function update(step) {
          let { currentTime, meta, isPlaying, speed } = self.get();
          if (!isPlaying) {
            return;
          }

          const stepDiff = Math.floor(step - lastStep);
          lastStep = step;
          currentTime += speed * stepDiff;
          self.set({
            currentTime: Math.min(currentTime, meta.totalTime),
          });

          if (currentTime < meta.totalTime) {
            requestAnimationFrame(update);
          } else {
            self.set({ isPlaying: false, currentTime: 0 });
          }
        }

        requestAnimationFrame(update);
      },
      play() {
        const { replayer } = this.get();
        // replayer.play();
        this.loopTimer();
      },
      pause() {
        const { replayer } = this.get();
        replayer.pause();
      },
      toggle() {
        const { isPlaying } = this.get();
        this.set({ isPlaying: !isPlaying });
        if (isPlaying) {
          this.pause();
        } else {
          this.play();
        }
      },
    },
    onupdate({ changed, current, previous }) {
      if (current.replayer && !previous) {
        // auto play
        this.set({ isPlaying: true });
        this.play();
      }
    },
  };
</script>

<style>
  .rr-controller {
    width: 100%;
    height: 80px;
    background: rgba(0, 0, 0, .5);
    display: flex;
    flex-direction: column;
    justify-content: space-around;
    align-items: center;
    padding: 10px;
  }

  .rr-timeline {
    width: 80%;
    display: flex;
    align-items: center
  }

  .rr-timeline__time {
    padding: 0 20px;
    color: white;
  }

  .rr-progress {
    width: 100%;
    height: 4px;
    background: white;
    position: relative;
    border-radius: 3px;
  }

  .rr-progress__step {
    height: 100%;
    position: absolute;
    left: 0;
    top: 0;
    background: orange
  }

  .rr-progress__handler {
    width: 20px;
    height: 20px;
    border-radius: 10px;
    position: absolute;
    top: 2px;
    transform: translate(-50%, -50%);
    background: orange;
  }

  .rr-controller__btns button.active {
    color: orange;
  }
</style>